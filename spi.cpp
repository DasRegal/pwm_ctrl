//*****************************************************************************
//
// Имя файла    : 'spi.cpp'
// Заголовок    : Драйвер SPI
// Автор        : Барышников Р. А.
// Контакты     : plexus_bra@rambler.ru
// Дата         : 26.06.2013
//
//*****************************************************************************

#include "spi.h"
#include "gpio.h"
#include <unistd.h>

// =============================================================================
//                           Глобальные переменные
// =============================================================================

	extern	CSPI spi;

// =============================================================================
//                                 Класс CSPI
// =============================================================================

// =============================================================================
///
///                                Конструктор
///
// =============================================================================

CSPI::CSPI()
{

}

// =============================================================================
///
///                            Инициализация SPI
///
// =============================================================================
/// \param  miso  Линия MISO
/// \param  mosi  Линия MOSI
/// \param  clk   Линия CLK
// =============================================================================

void CSPI::Init (int miso, int mosi, int clk)
{
	m_MISO = miso;
	m_MOSI = mosi;
	m_CLK  = clk;

	GPIOInit(m_MISO);
	GPIOInit(m_MOSI);
	GPIOInit(m_CLK);

	GPIOSet(m_MOSI);
	GPIOClr(m_CLK);

	m_us = 300;
}

// =============================================================================
///
///                            Установка задержки
///
// =============================================================================
/// \param  us  Значение в мкс.
// =============================================================================

void CSPI::SetDelay(int us)
{
	m_us = us;
}

// =============================================================================
///
///                            Отправка байта
///
// =============================================================================
/// \param  byte  Значение байта
// =============================================================================

void CSPI::WriteByte(char byte)
{
	for (int i = 0; i < 8; i++, byte <<= 1)
	{
		if ((byte & 0x80) >> 7) GPIOSet(m_MOSI);
		else		  GPIOClr(m_MOSI);

		usleep(m_us);
		GPIOSet(m_CLK);
		usleep(m_us);
		GPIOClr(m_CLK);
	}
	GPIOSet(m_MOSI);
}
